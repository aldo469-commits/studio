/**
 * @fileoverview Firestore Security Rules for EJA GlobalTrans Customer Incident Management Chat.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Customers can only access
 * their own profile data, incidents, and chat messages. A designated admin user
 * is granted broader read access for management purposes.
 *
 * Data Structure:
 * All data is nested under /customers/{customerId}.
 * - Customer profiles are stored directly under /customers/{customerId}.
 * - Incidents are stored under /customers/{customerId}/incidents/{incidentId}.
 * - Chat messages are stored under
 *   /customers/{customerId}/incidents/{incidentId}/messages/{messageId}.
 *
 * Key Security Decisions:
 * - Users can only create, read, update, and delete data under their own user ID.
 * - An admin user (defined by ADMIN_UID) can read all incidents and messages.
 * - Listing of other users is disallowed.
 * - Schema validation is relaxed to allow for rapid prototyping.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // IMPORTANT: Replace this with the actual UID of the admin user in a real application.
    function isAdmin() {
      return request.auth.uid == 'REPLACE_WITH_YOUR_ADMIN_USER_ID';
    }

    /**
     * @description Controls access to customer profile information.
     * @path /customers/{customerId}
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == customerId;
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Controls access to incidents reported by customers.
     * @path /customers/{customerId}/incidents/{incidentId}
     */
    match /customers/{customerId}/incidents/{incidentId} {
      allow get: if isOwner(customerId) || isAdmin();
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId) || isAdmin();
      allow delete: if isExistingOwner(customerId) || isAdmin();
    }

    /**
     * @description Controls access to chat messages within incidents.
     * @path /customers/{customerId}/incidents/{incidentId}/messages/{messageId}
     */
    match /customers/{customerId}/incidents/{incidentId}/messages/{messageId} {
      allow get: if isOwner(customerId) || isAdmin();
      allow list: if isOwner(customerId) || isAdmin();
      allow create: if isOwner(customerId) || isAdmin();
      allow update: if isExistingOwner(customerId) || isAdmin();
      allow delete: if isExistingOwner(customerId) || isAdmin();
    }
    
    /**
     * @description Admin access for collection group queries. Allows admin to list all incidents.
     * @path /{path=**}/incidents/{incidentId}
     */
    match /{path=**}/incidents/{incidentId} {
      allow list: if isAdmin();
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}
