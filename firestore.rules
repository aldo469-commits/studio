/**
 * @fileoverview Firestore Security Rules for EJA GlobalTrans Customer Incident Management Chat.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Customers can only access
 * their own profile data, incidents, and chat messages.
 *
 * Data Structure:
 * All data is nested under /customers/{customerId}.
 * - Customer profiles are stored directly under /customers/{customerId}.
 * - Incidents are stored under /customers/{customerId}/incidents/{incidentId}.
 * - Chat messages are stored under
 *   /customers/{customerId}/incidents/{incidentId}/messages/{messageId}.
 *
 * Key Security Decisions:
 * - Users can only create, read, update, and delete data under their own user ID.
 * - Listing of other users is disallowed.
 * - Schema validation is relaxed to allow for rapid prototyping.
 *
 * Denormalization for Authorization:
 * This ruleset relies on path-based ownership, avoiding the need for denormalization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to customer profile information.
     * @path /customers/{customerId}
     * @allow (create) User with ID 'user_abc' can create their profile at /customers/user_abc.
     * @deny (create) User with ID 'user_def' cannot create a profile at /customers/user_abc.
     * @allow (get) User with ID 'user_abc' can read their profile at /customers/user_abc.
     * @deny (get) User with ID 'user_def' cannot read the profile at /customers/user_abc.
     * @allow (update) User with ID 'user_abc' can update their profile at /customers/user_abc.
     * @deny (update) User with ID 'user_def' cannot update the profile at /customers/user_abc.
     * @allow (delete) User with ID 'user_abc' can delete their profile at /customers/user_abc.
     * @deny (delete) User with ID 'user_def' cannot delete the profile at /customers/user_abc.
     * @principle Enforces document ownership for all operations.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == customerId;
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Controls access to incidents reported by customers.
     * @path /customers/{customerId}/incidents/{incidentId}
     * @allow (create) User with ID 'user_abc' can create an incident at /customers/user_abc/incidents/incident_123.
     * @deny (create) User with ID 'user_def' cannot create an incident at /customers/user_abc/incidents/incident_123.
     * @allow (get) User with ID 'user_abc' can read their incident at /customers/user_abc/incidents/incident_123.
     * @deny (get) User with ID 'user_def' cannot read the incident at /customers/user_abc/incidents/incident_123.
     * @allow (update) User with ID 'user_abc' can update their incident at /customers/user_abc/incidents/incident_123.
     * @deny (update) User with ID 'user_def' cannot update the incident at /customers/user_abc/incidents/incident_123.
     * @allow (delete) User with ID 'user_abc' can delete their incident at /customers/user_abc/incidents/incident_123.
     * @deny (delete) User with ID 'user_def' cannot delete the incident at /customers/user_abc/incidents/incident_123.
     * @principle Enforces document ownership for all operations.
     */
    match /customers/{customerId}/incidents/{incidentId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Controls access to chat messages within incidents.
     * @path /customers/{customerId}/incidents/{incidentId}/messages/{messageId}
     * @allow (create) User with ID 'user_abc' can create a message at /customers/user_abc/incidents/incident_123/messages/message_456.
     * @deny (create) User with ID 'user_def' cannot create a message at /customers/user_abc/incidents/incident_123/messages/message_456.
     * @allow (get) User with ID 'user_abc' can read their message at /customers/user_abc/incidents/incident_123/messages/message_456.
     * @deny (get) User with ID 'user_def' cannot read the message at /customers/user_abc/incidents/incident_123/messages/message_456.
     * @allow (update) User with ID 'user_abc' can update their message at /customers/user_abc/incidents/incident_123/messages/message_456.
     * @deny (update) User with ID 'user_def' cannot update the message at /customers/user_abc/incidents/incident_123/messages/message_456.
     * @allow (delete) User with ID 'user_abc' can delete their message at /customers/user_abc/incidents/incident_123/messages/message_456.
     * @deny (delete) User with ID 'user_def' cannot delete the message at /customers/user_abc/incidents/incident_123/messages/message_456.
     * @principle Enforces document ownership for all operations.
     */
    match /customers/{customerId}/incidents/{incidentId}/messages/{messageId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}